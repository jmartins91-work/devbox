name: Docker Build and Validate

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t devbox:test .
      
      - name: Start Docker container
        env:
          DEVBOX_WORKDIR: ${{ github.workspace }}
          UID: 1000
          GID: 1000
          TZ: UTC
        run: docker compose up -d
      
      - name: Wait for container to be ready
        run: sleep 5
      
      - name: Validate container is running
        env:
          DEVBOX_WORKDIR: ${{ github.workspace }}
        run: |
          if docker compose ps | grep -q "Up"; then
            echo "✅ Container is running successfully"
          else
            echo "❌ Container failed to start"
            docker compose logs
            exit 1
          fi
      
      - name: Run validation script
        run: |
          if [ -f "./validate_container.sh" ]; then
            chmod +x ./validate_container.sh
            ./validate_container.sh
          else
            echo "⚠️ validate_container.sh not found, skipping"
          fi
      
      - name: Cleanup
        if: always()
        env:
          DEVBOX_WORKDIR: ${{ github.workspace }}
        run: docker compose down
